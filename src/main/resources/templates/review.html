<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>网签审核系统</title>
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/themes/default/easyui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/themes/icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/themes/color.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/demo/demo.css}">
    <script type="text/javascript" th:src="@{/easyui/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/easyui/jquery.easyui.min.js}"></script>
    <script type="text/javascript" th:src="@{/easyui/locale/easyui-lang-zh_CN.js}"></script>
</head>

<body style="padding: 0px">
<table id="dg" title="审核列表" class="easyui-datagrid" style="width:100%;height:800px"
       pagination="true"
       toolbar="#toolbar"
       url="getOrders"
       rownumbers="true"
       fitColumns="true"
       singleSelect="true"
       data-options="onClickCell:onClickCell"
       loadMsg="正在查询...">

    <thead>
    <tr>
        <th field="id" width="5%" >订单号</th>
        <th field="templateId" width="4%">合同模板序号</th>
        <th field="orderNum" width="4%">业务编码</th>
        <th field="createTime" width="10%">订单生成时间</th>
        <th field="itemName" width="4%">货物名称</th>
        <th field="price" width="3%">价格</th>
        <th field="status" width="4%" >审核状态</th>
        <th field="companyName" width="15%">甲方</th>
        <th field="supplierId" width="4%">乙方序号</th>
        <th field="supplierName" width="5%">乙方姓名</th>
        <th field="supplierIdNum" width="10%">乙方身份证号</th>
        <th field="bankName" width="4%" data-options="editor:'text'">开户行</th>
        <th field="branchBankName" width="6%" data-options="editor:'text'">支行</th>
        <th field="bankNum" width="11%">银行卡号</th>
        <th field="startDate" width="8%">合同生效日期</th>
        <th field="endDate" width="8%">合同失效日期</th>
        <th field="updateTime" width="8%">合同信息更新时间</th>
    </tr>
    </thead>
</table>

<!--分页-->
<!--<div id="pp" style="background:#efefef;border:1px solid #ccc;"></div>-->


<div id="toolbar">
    <a  href="#" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="pass()">审核通过</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-no" plain="true" onclick="notpass()">审核不通过</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" onclick="deleteOrder()">删除记录</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-reload" plain="true" onclick="reload()">刷新记录</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="update()">提交修改并生成新合同文件</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="uploadStamp()">上传盖章文件</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="openPDF()">查看合同</a>
    <a  href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="downloadContract()">下载选中的合同</a>
</div>

<!--文件上传-->
<div id="uploadStamp" class="easyui-window" style="width:380px;padding:10px 40px" closed="true">
    <form id="stamp" method="post" enctype="multipart/form-data">
        <table border="0" style="margin-top:4px;" width="100%" align="center">
            <tr>
                <td>
                    <input class="easyui-filebox" name="upload" data-options="buttonText:'选择文件',prompt:'文件上传'" style="width:100%"></input>
                </td>
            </tr>
        </table>
    </form>

    <div data-options="region:'south',border:false" style="text-align:center;padding:5px 0 0;">
        <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="uploadonline('#stamp');" style="width:80px">上传</a>
    </div>
</div>

</body>

<!--分页-->
<!--<script type="text/javascript">-->

<!--    $('#pp').pagination({-->
<!--        total:getCountOfOrders(),-->
<!--        pageSize:10-->
<!--    });-->

<!--     function getCountOfOrders()  {-->
<!--        $.ajax({-->
<!--            url:"getCountOfOrders",-->
<!--            type:"post",-->
<!--            datatype:"josn",-->
<!--            success:function(result){-->
<!--                return result.data;-->
<!--            }-->
<!--        });-->
<!--    }-->
<!--</script>-->


<script type="text/javascript">

    function downloadContract() {
        var row = $('#dg').datagrid('getSelected');
        var orderId=row.id;
        if (row){
            var url="/hetong/download/download?orderId="+orderId;
            window.open(url);
        }
    }

    //盖章
    function uploadStamp() {
        var row = $('#dg').datagrid('getSelected');
        if(row)
        {
            if(row.status!=="待盖章")
            {
                alert("状态为待盖章的才可以上传盖章文件");
            }else
            {
                $('#uploadStamp').window('open').dialog('setTitle','盖章文件上传');
            }
        }
        else
        {
            alert("请选择合同");
        }

    }

    function uploadonline(id) {
        var row = $('#dg').datagrid('getSelected');
        var orderId=row.id;
        if(row.status!=="待盖章")
        {
            alert("状态为待盖章的才可以上传盖章文件");
        }
        else
        {
            var add="/hetong/web/uploadContractFile?id="+orderId;
            $(id).form('submit',{
                url: add,
                onSubmit: function(){
                },
                success: function(result){
                    reload();
                    var result = eval('('+result+')');
                    if (result.status==200){
                        $('#uploadonlineinfo').window('close');
                        $('#dg2').datagrid('reload');
                        $.messager.show({
                            title: 'Success',
                            msg: '上传成功'
                        });
                    } else {
                        $.messager.show({
                            title: 'Error',
                            msg: result.message
                        });
                    }
                }
            });
        }
    }


    // function stamp() {
    //     var row = $('#dg').datagrid('getSelected');
    //     if (row){
    //         var id=row.id;
    //         $.ajax({
    //             url:"contract/stamp",
    //             type:"post",
    //             data:{
    //                 id:id,
    //             },
    //             datatype:"josn",
    //             success:function(result){
    //                 $('#dg').datagrid('reload');
    //             }
    //         });
    //     }
    // }

    //通过审核
    function pass() {
        var row = $('#dg').datagrid('getSelected');
        if (row){
            var id=row.id;
            if(row.status!=="已提交")
            {
                alert("状态为已提交的才可以通过");
            }
            $.ajax({
                url:"/hetong/web/passOrder",
                type:"post",
                data:{
                    id:id,
                },
                datatype:"josn",
                success:function(result){
                    $('#dg').datagrid('reload');
                }
            });
        }
    }

    //不通过审核
    function notpass() {
        var row = $('#dg').datagrid('getSelected');
        if (row){
            var id=row.id;
            $.ajax({
                url:"/hetong/web/notPassOrder",
                type:"post",
                data:{
                    id:id,
                },
                datatype:"josn",
                success:function(result){
                    $('#dg').datagrid('reload');
                }
            });
        }
    }

    //不通过审核
    function deleteOrder() {
        var row = $('#dg').datagrid('getSelected');
        if (row){
            var id=row.id;
            $.ajax({
                url:"/hetong/web/deleteOrder",
                type:"post",
                data:{
                    id:id,
                },
                datatype:"josn",
                success:function(result){
                    $('#dg').datagrid('reload');
                }
            });
        }
    }
    //刷新
    function reload() {
        $('#dg').datagrid('reload');
    }

    //更新数据
    function update() {
        var row = $('#dg').datagrid('getSelected');
        if (row){
            var id=row.id;
            var templateId=row.templateId;
            var supplierId=row.supplierId;
            var itemName=row.itemName;
            var bankName=row.bankName;
            var branchBankName=row.branchBankName;
            $.ajax({
                url:"/hetong/web/update",
                type:"post",
                data:JSON.stringify(
                    {
                        id:id,
                        templateId:templateId,
                        supplierId:supplierId,
                        bankName:bankName,
                        branchBankName:branchBankName,
                        itemName:itemName,
                    }
                ),
                datatype:"josn",
                contentType:"application/json",
                success:function(result){
                    if(result.data===true)
                    {
                        alert("修改成功");
                    }
                    $('#dg').datagrid('reload');
                }
            });
        }
    }


    //查看合同
    function openPDF()
    {
        var row = $('#dg').datagrid('getSelected');
        var orderId=row.id;
        if (row){
            var url="/hetong/download/download?orderId="+orderId+"&model=0";
            window.open(url);
        }
    }


</script>


<!--表格可编辑-->
<script type="text/javascript">
    $.extend($.fn.datagrid.methods, {
        editCell: function (jq, param) {
            return jq.each(function () {
                var opts = $(this).datagrid('options');
                var fields = $(this).datagrid('getColumnFields', true).concat($(this).datagrid('getColumnFields'));
                for (var i = 0; i < fields.length; i++) {
                    var col = $(this).datagrid('getColumnOption', fields[i]);
                    col.editor1 = col.editor;
                    if (fields[i] != param.field) {
                        col.editor = null;
                    }
                }
                $(this).datagrid('beginEdit', param.index);
                for (var i = 0; i < fields.length; i++) {
                    var col = $(this).datagrid('getColumnOption', fields[i]);
                    col.editor = col.editor1;
                }
            });
        }
    });

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#dg').datagrid('validateRow', editIndex)) {
            $('#dg').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        } else {
            return false;
        }
    }
    function onClickCell(index, field) {
        if (endEditing()) {
            $('#dg').datagrid('selectRow', index)
                .datagrid('editCell', { index: index, field: field });
            editIndex = index;
        }
    }
</script>
</html>